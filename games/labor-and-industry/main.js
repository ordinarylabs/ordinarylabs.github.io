"use strict";(()=>{var L=n=>{throw TypeError(n)};var H=(n,e,t)=>e.has(n)||L("Cannot "+t);var W=(n,e,t)=>(H(n,e,"read from private field"),t?t.call(n):e.get(n)),Q=(n,e,t)=>e.has(n)?L("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),S=(n,e,t,i)=>(H(n,e,"write to private field"),i?i.call(n,t):e.set(n,t),t);var j=[[0,10,-6],[10,20,-5],[21,30,-4],[31,50,-3],[51,70,-2],[71,90,-1],[91,100,0]],d={MANAGER:[0,1],ENGINEER:[1,2],OPERATOR:[2,3]},Y=[-3,-2,-1,0],B=[-1,0,1],F=[0,-1,-2,-3],x=[[0,5,-2],[6,10,-1],[11,20,0],[21,50,1],[51,100,2]];function N(){return Math.floor(Math.random()*6)+1}var m=class{constructor(e){this.number=e,this.role=null,this.isWinner=!1}assignRole(e){this.role===null&&(this.role=e)}makeWinner(){this.isWinner=!0}},_=class{constructor(e,t){if(this.players=e,this.evtHandler=t,e.length<4||e.length>10)throw new Error("game only accommodates 4 to 10 players");this.managerIncome=new I,this.engineerIncome=new I,this.operatorIncome=new I,this.manager=new M(this.managerIncome,this.engineerIncome,this.operatorIncome),this.engineers=[],this.operators=[];for(let i=0;i<e.length;i+=1){let s=e[i];switch(i){case 0:{s.assignRole(this.manager);break}case 1:case 5:case 7:{let o=new E(this.engineerIncome);this.engineers.push(o),s.assignRole(o);break}default:{let o=new h(this.operatorIncome);this.operators.push(o),s.assignRole(o)}}}this.currentYear=0,this.currentQuarter=0,this.currentMonth=0,this.process=new P,this.units=new G,this.cash=new C,this.inventory=new D,this.demand=new q,this.costOfGoods=new v,this.equipmentDeck=new b([]),this.mishapDeck=new b([]),this.mishapDrawnCount=0}start(){let e=3;this.engineers.length===2?e=2:this.engineers.length===3&&(e=1),this.players.forEach(t=>{if(t.role instanceof E)for(let i=0;i<e-1;i+=1)this.evtHandler({kind:"ENGINEER_DRAW_EQUIPMENT",playerNumber:t.number,optional:!1})}),this.startYear()}end(){let e=j.reduce((i,s)=>this.units.overall>=s[0]&&this.units.overall<s[1]?s[2]:i,0),t=N()+e>1;this.players.forEach(i=>{let{role:s}=i,o=N(),r=x.reduce((a,u)=>s&&s.wealth.get()>=u[0]&&s.wealth.get()<u[1]?u[2]:a,0);if(o+=r,s instanceof M){t&&s.profitableYearsCount<3?o-=d.MANAGER[1]:o-=d.MANAGER[0];let a=Y[s.profitableYearsCount];o+=a}else if(s instanceof E){t&&(s.level.overall===0?o-=d.ENGINEER[1]:o-=d.ENGINEER[0]);let a=B[s.level.overall];o+=a}else if(s instanceof h){t&&(s.injuries.overall===0?o-=d.OPERATOR[1]:o-=d.OPERATOR[0]);let a=F[s.injuries.overall];o+=a}o>1&&i.makeWinner()})}startYear(){if(this.currentYear+=1,this.currentYear>3){this.end();return}this.evtHandler({kind:"START_YEAR"});let e=this.evtHandler({kind:"MANAGER_SET_INCOME"});for(e.kind==="MANAGER_SET_INCOME"&&(this.manager.setManagerIncome(e.manager),this.manager.setEngineerIncome(e.engineer),this.manager.setOperatorIncome(e.operator));this.currentQuarter<4;)this.startQuarter();this.currentQuarter=0}startQuarter(){for(this.currentQuarter+=1,this.evtHandler({kind:"START_QUARTER"});this.currentMonth<3;)this.startMonth();this.players.forEach(e=>{e.role instanceof E&&e.role.resetQuarterlyEquipmentDrawCount()}),this.mishapDrawnCount=0,this.currentMonth=0}startMonth(){this.currentMonth+=1,this.evtHandler({kind:"START_MONTH"}),this.players.forEach(r=>{if(r.role instanceof E&&r.role.level.overall>r.role.quarterlyEquipmentDrawnCount){let a=this.evtHandler({kind:"ENGINEER_DRAW_EQUIPMENT",optional:!0,playerNumber:r.number});if(a.kind==="ENGINEER_DRAW_EQUIPMENT"&&a.accepted){let u=this.equipmentDeck.draw();if(r.role.incrementQuarterlyEquipmentDrawCount(),r.role.equipment.length===3){let c=this.evtHandler({kind:"ENGINEER_DISCARD_EQUIPMENT",playerNumber:r.number,equipment:[...r.role.equipment,u].map(l=>({id:l.id}))});c.kind==="ENGINEER_DISCARD_EQUIPMENT"&&(u.id!==c.equipmentId?r.role.setEquipment(r.role.equipment.map(l=>c.equipmentId===l.id?(this.equipmentDeck.discardInto(l),u):l)):this.equipmentDeck.discardInto(u))}}}}),this.evtHandler({kind:"OPERATORS_ROLL_COST_OF_GOODS"});let e=N();this.costOfGoods.set(e),this.evtHandler({kind:"OPERATORS_SET_MAINTENANCE_DUE"});let t=!0;for(;t;){t=!1;for(let r=0;r<this.players.length;r+=1){let a=this.players[r];if(a.role instanceof E&&a.role.time.current>0&&!a.role.isDoneWithMonthlyRequests){let u=[];if(u.length>0){let c=this.evtHandler({kind:"ENGINEER_REQUEST",availableActions:u});if(c.kind==="ENGINEER_DONE_WITH_REQUESTS")a.role.setIsDoneWithMonthlyRequests();else if(c.kind==="ENGINEER_REQUEST")for(let l=0;l<c.actions.length;l+=1){let U=c.actions[l],g=this.evtHandler({kind:"REQUEST_MANAGER_APPROVAL",action:U});g.kind==="MANAGER_APPROVED"?a.role.time.current>0&&(t=!0):g.kind==="MANAGER_DENIED"&&g.withPrejudice&&a.role.setIsDoneWithMonthlyRequests()}}else a.role.setIsDoneWithMonthlyRequests()}}}let i=this.evtHandler({kind:"CHECK_FOR_STRIKE_INTENT"});if(i.kind==="INTENDS_TO_STRIKE"){let r=new Set(i.playerNumbers),a=0;for(let u=0;u<this.players.length;u+=1){let c=this.players[u];r.has(c.number)&&c.role instanceof h&&(c.role.voteToStrike(),a+=1)}a>Math.floor(this.operators.length/2)&&this.evtHandler({kind:"STRIKE"})}this.process.equipment.forEach(r=>{if(r.needsMaintenance&&(this.evtHandler({kind:"ROLL_FOR_DELAYED_MAINTENANCE_BREAKAGE",equipmentId:r.id}),N()>r.maintenanceBreakageThreshold)){this.evtHandler({kind:"EQUIPMENT_BREAKS",equipmentId:r.id,dueToLackOfMaintenance:!0});let u=r.break("maintenance");this.randomlyInjureOperators(u)}});let s=!0,o=!1;switch(this.operators.length){case 2:case 3:{s=this.mishapDrawnCount<1,o=!(this.mishapDrawnCount===0&&this.currentMonth===3);break}case 4:case 5:{s=this.mishapDrawnCount<2,o=!(this.mishapDrawnCount===0&&this.currentMonth===2||this.mishapDrawnCount===1&&this.currentMonth===3);break}default:break}if(s){let r=this.evtHandler({kind:"OPERATORS_DRAW_MISHAP",optional:o});if(r.kind==="OPERATORS_DRAW_MISHAP"&&r.accepted){this.mishapDrawnCount+=1;let a=this.mishapDeck.draw();this.process.refinement<a.processRefinementThreshold&&(this.randomlyInjureOperators(a.injuryCount),this.mishapDeck.discardInto(a))}}this.players.forEach(r=>{r.role instanceof E?r.role.resetIsDoneWithMonthlyRequests():r.role instanceof h&&r.role.resetStrikeIntent()})}randomlyInjureOperators(e){let t=this.evtHandler({kind:"RANDOMLY_SELECT_INJURED_OPERATORS",count:e});if(t.kind==="RANDOMLY_SELECT_INJURED_OPERATORS"){let i=new Set(t.playerNumbers);this.players.forEach(s=>{i.has(s.number)&&s.role instanceof h&&(s.role.injuries.increment(1),this.evtHandler({kind:"INJURE_OPERATOR",playerNumber:s.number}))})}}},b=class{constructor(e){this.cards=e,this.discard=[]}draw(){let e=this.cards.pop();return e||(this.shuffle(),e=this.cards.pop(),e)}discardInto(e){this.discard.push(e)}shuffle(){let e=this.cards.concat(this.discard);for(let t=e.length-1;t>0;t-=1){let i=Math.floor(Math.random()*(t+1)),s=e[t];e[t]=e[i],e[i]=s}this.cards=e,this.discard=[]}},p,R=class{constructor(){Q(this,p);S(this,p,0)}set(e){S(this,p,e)}get(){return W(this,p)}};p=new WeakMap;var I=class extends R{},T=class extends R{constructor(e,t){super(),this.set(e),this.max=t}},D=class extends R{},v=class extends R{},q=class extends R{},f=class{constructor(){this.overall=0,this.intermediate=0}increment(e){this.intermediate+=e}consolidate(){this.overall+=this.intermediate,this.intermediate=0}},w=class extends f{},y=class extends f{},C=class extends f{},G=class extends f{},k=class{constructor(e){this.base=e,this.current=e}use(e){if(this.current>=e)this.current-=e;else throw new Error("not enough time")}reset(){this.current=this.base}},P=class{constructor(){this.refinement=1,this.equipment=[]}refine(e){this.equipment.forEach(t=>{e.engineer.use(t.timeToRefine.engineer),e.operator.forEach(i=>{i.use(t.timeToRefine.operator)})}),this.refinement+=1}swapEquipment(){this.refinement-=1}};var A=class{constructor(e,t){this.income=e,this.wealth=t}},O=class{constructor(e){this.action=e}approve(){this.action()}},M=class extends A{constructor(e,t,i){super(e,new T(20,100)),this.years=[null,null,null],this.engineerIncome=t,this.operatorIncome=i}get profitableYearsCount(){return this.years.reduce((e,t)=>t?e+1:e,0)}setManagerIncome(e){this.income.set(e)}setEngineerIncome(e){this.engineerIncome.set(e)}setOperatorIncome(e){this.operatorIncome.set(e)}static approve(e){e.approve()}},E=class extends A{constructor(e){super(e,new T(10,50)),this.time=new k(40),this.level=new y,this.equipment=[],this.quarterlyEquipmentDrawnCount=0,this.isDoneWithMonthlyRequests=!1}setEquipment(e){this.equipment=e}incrementQuarterlyEquipmentDrawCount(){this.quarterlyEquipmentDrawnCount+=1}resetQuarterlyEquipmentDrawCount(){this.quarterlyEquipmentDrawnCount=0}setIsDoneWithMonthlyRequests(){this.isDoneWithMonthlyRequests=!0}resetIsDoneWithMonthlyRequests(){this.isDoneWithMonthlyRequests=!1}requestRefinement(e,t){return new O(()=>{this.refineProcess(e,t)})}refineProcess(e,t){e.refine({engineer:this.time,operator:t})}requestEquipment(e){return new O(()=>{this.installEquipment(e)})}installEquipment(e){this.time.use(e.timeToInstall)}repairEquipment(e){this.time.use(e.timeToService)}},h=class extends A{constructor(e){super(e,new T(5,25)),this.time=new k(40),this.injuries=new w,this.intendsToStrike=!1}voteToStrike(){this.intendsToStrike=!0}resetStrikeIntent(){this.intendsToStrike=!1}};var K=[new m(1),new m(2),new m(3),new m(4)],J=new _(K,()=>({kind:"NONE"}));J.start();})();
